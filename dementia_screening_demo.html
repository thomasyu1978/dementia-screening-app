<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitive Health Screening Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .pulse {
            animation: pulse-animation 1.5s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 max-w-2xl w-full m-4">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Cognitive Health Screening</h1>
            <p class="text-gray-500 mt-2">Please read the following passage aloud clearly and at a natural pace.</p>
        </header>

        <div class="bg-gray-100 rounded-lg p-4 mb-6 text-gray-700">
            <p>"The sun dips below the horizon, painting the sky in shades of orange and purple. A gentle breeze rustles the leaves in the tall trees that line the quiet park path. Children's laughter echoes in the distance as they finish their games. It's a peaceful end to a long day, a time for quiet reflection and rest."</p>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
            <button id="recordButton" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105">
                <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                <span id="recordButtonText">Start Recording</span>
            </button>
            <button id="stopButton" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105" disabled>
                Stop Recording
            </button>
        </div>

        <div id="status" class="text-center text-gray-500 mb-6 h-6"></div>

        <div id="results" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Analysis Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-500 font-medium">Speaking Rate</p>
                    <p id="speakingRate" class="text-2xl font-bold text-blue-800">-</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-500 font-medium">Pause Duration</p>
                    <p id="pauseDuration" class="text-2xl font-bold text-green-800">-</p>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg">
                    <p class="text-sm text-indigo-500 font-medium">Lexical Richness</p>
                    <p id="lexicalRichness" class="text-2xl font-bold text-indigo-800">-</p>
                </div>
            </div>
             <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-500 font-medium text-center">Transcript</p>
                <p id="transcript" class="text-gray-700 italic text-center">"</p>
            </div>
            <div id="riskAssessment" class="p-4 rounded-lg">
                <p class="text-sm font-medium text-center" id="riskLevel">-</p>
                <p class="text-center mt-1" id="suggestion">-</p>
            </div>
        </div>
    </div>

    <script>
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const recordButtonText = document.getElementById('recordButtonText');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        const micIcon = document.getElementById('micIcon');

        // Result display elements
        const speakingRateEl = document.getElementById('speakingRate');
        const pauseDurationEl = document.getElementById('pauseDuration');
        const lexicalRichnessEl = document.getElementById('lexicalRichness');
        const transcriptEl = document.getElementById('transcript');
        const riskAssessmentEl = document.getElementById('riskAssessment');
        const riskLevelEl = document.getElementById('riskLevel');
        const suggestionEl = document.getElementById('suggestion');

        let mediaRecorder;
        let audioChunks = [];

        recordButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendAudioForAnalysis(audioBlob);
                    audioChunks = [];
                };

                recordButton.disabled = true;
                stopButton.disabled = false;
                recordButtonText.textContent = "Recording...";
                micIcon.classList.add('pulse');
                status.textContent = "Recording in progress... Click 'Stop Recording' when you are finished.";
                results.classList.add('hidden');
                
            } catch (error) {
                console.error("Error accessing microphone:", error);
                status.textContent = "Error: Could not access microphone. Please grant permission and try again.";
            }
        });

        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
            recordButton.disabled = false;
            stopButton.disabled = true;
            recordButtonText.textContent = "Start Recording";
            micIcon.classList.remove('pulse');
            status.textContent = "Processing your audio... Please wait.";
        });

        async function sendAudioForAnalysis(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            
            try {
                // --- 核心改动：使用相对URL而不是写死的本地地址 ---
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                // --- 改动结束 ---

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                console.error("Error sending audio to backend:", error);
                status.textContent = `Analysis failed: ${error.message}. Please try again.`;
                results.classList.add('hidden');
            }
        }

        function displayResults(data) {
            status.textContent = "";
            results.classList.remove('hidden');

            speakingRateEl.textContent = data.speakingRate || "-";
            pauseDurationEl.textContent = data.pauseDuration || "-";
            lexicalRichnessEl.textContent = data.lexicalRichness || "-";
            transcriptEl.textContent = `"${data.transcript || 'Could not transcribe.'}"`;
            riskLevelEl.textContent = data.riskLevel || "Error";
            suggestionEl.textContent = data.suggestion || "Could not generate suggestion.";

            // Update risk assessment colors
            riskAssessmentEl.classList.remove('bg-green-100', 'bg-yellow-100', 'bg-red-100', 'text-green-800', 'text-yellow-800', 'text-red-800');
            riskLevelEl.classList.remove('text-green-700', 'text-yellow-700', 'text-red-700');

            if (data.riskLevel === 'Low Risk') {
                riskAssessmentEl.classList.add('bg-green-100', 'text-green-800');
                riskLevelEl.classList.add('text-green-700');
            } else if (data.riskLevel === 'Medium Risk') {
                riskAssessmentEl.classList.add('bg-yellow-100', 'text-yellow-800');
                riskLevelEl.classList.add('text-yellow-700');
            } else {
                riskAssessmentEl.classList.add('bg-red-100', 'text-red-800');
                riskLevelEl.classList.add('text-red-700');
            }
        }
    </script>
</body>
</html>


